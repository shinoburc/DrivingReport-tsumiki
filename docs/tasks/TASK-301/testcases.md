# TASK-301: 運転日報コントローラー実装 - テストケース設計

## テストケース一覧

### 1. 運転記録CRUD操作テスト

#### TC-001: 新規運転記録の作成
- **目的**: 新しい運転記録を作成できることを確認
- **入力**: createLog()
- **期待結果**: 
  - DrivingLogModelが返される
  - 一意のIDが生成される
  - statusがIN_PROGRESSに設定される
  - createdAtが現在時刻

#### TC-002: 初期データ付き記録作成
- **目的**: 初期データを指定して記録を作成
- **入力**: createLog({ purpose: '営業活動', memo: '顧客訪問' })
- **期待結果**: 
  - 指定したデータが設定される
  - その他はデフォルト値

#### TC-003: 運転記録の取得
- **目的**: IDで記録を取得できることを確認
- **入力**: getLog(logId)
- **期待結果**: 
  - 指定IDの記録が返される
  - 存在しないIDの場合はnull

#### TC-004: アクティブな記録の取得
- **目的**: 進行中の記録のみ取得
- **入力**: getActiveLogs()
- **期待結果**: 
  - statusがIN_PROGRESSの記録のみ返される

#### TC-005: 運転記録の更新
- **目的**: 既存記録を更新できることを確認
- **入力**: updateLog(logId, { memo: '更新されたメモ' })
- **期待結果**: 
  - 指定フィールドが更新される
  - updatedAtが更新される

#### TC-006: 運転記録の削除（論理削除）
- **目的**: 記録を論理削除できることを確認
- **入力**: deleteLog(logId, true)
- **期待結果**: 
  - deletedAtが設定される
  - 通常の取得では表示されない

### 2. 地点管理テスト

#### TC-007: 出発地点の追加
- **目的**: 記録に出発地点を追加
- **入力**: addLocation(logId, location, LocationType.START)
- **期待結果**: 
  - startLocationが設定される
  - startTimeが記録される

#### TC-008: 経由地点の追加
- **目的**: 経由地点を追加
- **入力**: addLocation(logId, location, LocationType.WAYPOINT)
- **期待結果**: 
  - waypointsリストに追加される
  - 順序が保持される

#### TC-009: 到着地点の追加
- **目的**: 記録に到着地点を追加
- **入力**: addLocation(logId, location, LocationType.END)
- **期待結果**: 
  - endLocationが設定される
  - endTimeが記録される

#### TC-010: 重複地点の防止
- **目的**: 同じ地点の重複追加を防ぐ
- **入力**: 同じ地点を連続して追加
- **期待結果**: 
  - エラーまたは警告
  - 重複が防止される

### 3. 簡易入力モードテスト

#### TC-011: クイックスタート
- **目的**: ワンタップで記録開始
- **入力**: quickStart()
- **期待結果**: 
  - 新規記録が作成される
  - GPS位置が出発地点に設定される

#### TC-012: クイックスタート（地点指定）
- **目的**: 指定地点で記録開始
- **入力**: quickStart(favoriteLocation)
- **期待結果**: 
  - 指定地点が出発地点になる

#### TC-013: 経由地点のクイック追加
- **目的**: ワンタップで経由地点追加
- **入力**: quickAddWaypoint(logId, location)
- **期待結果**: 
  - 経由地点が追加される
  - 自動保存される

#### TC-014: クイック完了
- **目的**: ワンタップで記録完了
- **入力**: quickComplete(logId, endLocation)
- **期待結果**: 
  - 到着地点が設定される
  - statusがCOMPLETEDになる
  - 距離・時間が計算される

### 4. 状態管理テスト

#### TC-015: 正常な状態遷移（進行中→完了）
- **目的**: IN_PROGRESS → COMPLETED の遷移
- **入力**: changeStatus(logId, DrivingLogStatus.COMPLETED)
- **期待結果**: 
  - statusがCOMPLETEDになる
  - endTimeが設定される

#### TC-016: 正常な状態遷移（進行中→キャンセル）
- **目的**: IN_PROGRESS → CANCELLED の遷移
- **入力**: cancelLog(logId, '天候不良')
- **期待結果**: 
  - statusがCANCELLEDになる
  - キャンセル理由が記録される

#### TC-017: 不正な状態遷移の防止
- **目的**: COMPLETED → IN_PROGRESS など不正な遷移を防ぐ
- **入力**: 完了済み記録のstatusを変更
- **期待結果**: 
  - エラーが発生
  - 状態が変更されない

#### TC-018: 必須項目チェック
- **目的**: 完了時の必須項目を検証
- **入力**: 出発地点なしでcompleteLog()
- **期待結果**: 
  - バリデーションエラー
  - 「出発地点が必要です」メッセージ

### 5. 自動保存テスト

#### TC-019: 自動保存の有効化
- **目的**: 定期的な自動保存を開始
- **入力**: enableAutoSave(logId, 30000)
- **期待結果**: 
  - 30秒ごとに保存される
  - unsavedChangesフラグが管理される

#### TC-020: 自動保存の無効化
- **目的**: 自動保存を停止
- **入力**: disableAutoSave(logId)
- **期待結果**: 
  - 自動保存が停止される
  - タイマーがクリアされる

#### TC-021: 手動保存
- **目的**: 明示的に保存を実行
- **入力**: saveLog(logId)
- **期待結果**: 
  - データが永続化される
  - lastSaveTimeが更新される

#### TC-022: 未保存変更の検出
- **目的**: 未保存の変更があるか確認
- **入力**: hasUnsavedChanges(logId)
- **期待結果**: 
  - 変更後: true
  - 保存後: false

### 6. 復旧機能テスト

#### TC-023: 進行中記録の復旧
- **目的**: クラッシュ後の記録復旧
- **入力**: recoverInProgressLogs()
- **期待結果**: 
  - 進行中記録が復元される
  - データの整合性が保たれる

#### TC-024: 最終保存時刻の取得
- **目的**: 最後の保存時刻を確認
- **入力**: getLastSaveTime(logId)
- **期待結果**: 
  - 正確な保存時刻が返される

#### TC-025: 重複記録の防止
- **目的**: 同じ記録の重複作成を防ぐ
- **入力**: 復旧時に同じ記録が存在
- **期待結果**: 
  - 重複が検出される
  - 既存記録が優先される

### 7. 統計・集計テスト

#### TC-026: 走行距離の計算
- **目的**: 記録の総距離を計算
- **入力**: calculateDistance(logId)
- **期待結果**: 
  - 全地点間の距離合計
  - km単位で返される

#### TC-027: 所要時間の計算
- **目的**: 記録の総時間を計算
- **入力**: calculateDuration(logId)
- **期待結果**: 
  - 開始から終了までの時間
  - 分単位で返される

#### TC-028: 期間内総距離の集計
- **目的**: 指定期間の総走行距離
- **入力**: getTotalDistance(startDate, endDate)
- **期待結果**: 
  - 期間内の全記録の距離合計
  - 完了済み記録のみ対象

### 8. エラーハンドリングテスト

#### TC-029: 未来日時の警告
- **目的**: 未来の日時入力を警告
- **入力**: 未来の日時で記録作成
- **期待結果**: 
  - 警告メッセージ表示
  - 作成は許可（警告のみ）

#### TC-030: ストレージエラー処理
- **目的**: 保存失敗時の処理
- **入力**: ストレージ容量不足状態で保存
- **期待結果**: 
  - エラーメッセージ表示
  - ローカルバックアップ作成

#### TC-031: 同時編集の防止
- **目的**: 同じ記録の同時編集を防ぐ
- **入力**: 複数箇所から同時更新
- **期待結果**: 
  - 楽観的ロック機能
  - 競合検出と解決

### 9. データ検証テスト

#### TC-032: 必須フィールド検証
- **目的**: 必須項目の検証
- **入力**: 必須項目なしで作成
- **期待結果**: 
  - バリデーションエラー
  - 具体的なエラー内容

#### TC-033: データ型検証
- **目的**: 不正なデータ型を拒否
- **入力**: 文字列を数値フィールドに設定
- **期待結果**: 
  - 型エラー
  - 自動変換または拒否

#### TC-034: 参照整合性
- **目的**: 地点IDの妥当性確認
- **入力**: 存在しない地点IDを参照
- **期待結果**: 
  - 参照エラー
  - 整合性チェック

## モックデータ

```typescript
// テスト用運転記録
const mockLog = {
  id: 'test-log-001',
  date: new Date('2024-01-15'),
  startTime: new Date('2024-01-15T09:00:00'),
  endTime: new Date('2024-01-15T17:00:00'),
  startLocation: {
    id: 'loc-001',
    name: '自宅',
    latitude: 35.6762,
    longitude: 139.6503,
    type: LocationType.START
  },
  waypoints: [
    {
      id: 'loc-002',
      name: '顧客A',
      latitude: 35.6580,
      longitude: 139.7016,
      type: LocationType.WAYPOINT
    }
  ],
  endLocation: {
    id: 'loc-003',
    name: '会社',
    latitude: 35.6897,
    longitude: 139.6922,
    type: LocationType.END
  },
  distance: 45.5,
  duration: 480,
  purpose: '営業活動',
  status: DrivingLogStatus.COMPLETED
};

// 進行中の記録
const mockActiveLog = {
  ...mockLog,
  id: 'test-log-002',
  status: DrivingLogStatus.IN_PROGRESS,
  endTime: undefined,
  endLocation: undefined
};
```

## テスト優先順位

1. **必須テスト**（P1）
   - TC-001, TC-007, TC-011, TC-015, TC-019, TC-023

2. **重要テスト**（P2）
   - TC-003, TC-005, TC-014, TC-017, TC-026, TC-029

3. **補完テスト**（P3）
   - その他のテストケース