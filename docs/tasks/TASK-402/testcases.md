# TASK-402: Export Controller Implementation - テストケース設計

## テストケース一覧

### 1. 設定管理機能テスト

#### TC-001: 基本設定の保存・読み込み
- **目的**: エクスポート設定の永続化機能確認
- **入力**: デフォルト設定オブジェクト
- **期待結果**: 
  - 設定が正確に保存される
  - 保存した設定が正確に読み込まれる
  - 設定の型安全性が保たれる

#### TC-002: 設定のバリデーション
- **目的**: 不正な設定値の検出・拒否
- **入力**: 不正な設定値（不正なフィールド、無効な日付範囲等）
- **期待結果**: 
  - 不正な設定が適切に検出される
  - 分かりやすいエラーメッセージが表示される
  - デフォルト値にフォールバックされる

#### TC-003: 設定の初期化
- **目的**: 初回利用時のデフォルト設定提供
- **入力**: 設定が存在しない状態
- **期待結果**: 
  - デフォルト設定が返される
  - 全ての必須項目が含まれる
  - 設定が適用可能である

#### TC-004: 設定の上書き保存
- **目的**: 既存設定の更新機能確認
- **入力**: 既存設定の一部を変更
- **期待結果**: 
  - 変更部分のみが更新される
  - 未変更部分は保持される
  - 更新タイムスタンプが更新される

### 2. プリセット管理機能テスト

#### TC-005: プリセットの作成
- **目的**: エクスポート設定をプリセットとして保存
- **入力**: 設定オブジェクト + プリセット名・説明
- **期待結果**: 
  - プリセットが正常に作成される
  - 一意のIDが付与される
  - 作成日時が記録される

#### TC-006: プリセット一覧の取得
- **目的**: 保存されたプリセットの一覧表示
- **入力**: プリセット取得リクエスト
- **期待結果**: 
  - 全てのプリセットが返される
  - 最近使用順でソートされる
  - デフォルトプリセットが識別される

#### TC-007: プリセットの削除
- **目的**: 不要なプリセットの削除機能
- **入力**: プリセットID
- **期待結果**: 
  - 指定したプリセットが削除される
  - 他のプリセットは影響されない
  - 削除後の一覧が正しく更新される

#### TC-008: デフォルトプリセットの設定
- **目的**: デフォルトとして使用するプリセットの指定
- **入力**: プリセットID + デフォルトフラグ
- **期待結果**: 
  - 指定したプリセットがデフォルトになる
  - 既存のデフォルトが解除される
  - 設定読み込み時にデフォルトが適用される

#### TC-009: プリセット名の重複チェック
- **目的**: 同名プリセットの作成防止
- **入力**: 既存と同じ名前のプリセット
- **期待結果**: 
  - 重複エラーが発生する
  - 代替名の提案が行われる
  - 上書き確認オプションが提供される

### 3. エクスポート実行機能テスト

#### TC-010: 基本エクスポート
- **目的**: 標準設定でのCSVエクスポート実行
- **入力**: デフォルト設定 + データ範囲
- **期待結果**: 
  - CSVファイルが正常に生成される
  - ダウンロードが開始される
  - 適切なファイル名が付けられる

#### TC-011: カスタム設定エクスポート
- **目的**: ユーザー定義設定でのエクスポート
- **入力**: カスタム設定（フィールド選択、フィルタ等）
- **期待結果**: 
  - 指定した設定が適用される
  - 選択したフィールドのみが出力される
  - フィルタリング条件が正しく動作する

#### TC-012: 大量データエクスポート
- **目的**: 大量データの処理性能確認
- **入力**: 3000件のモックデータ
- **期待結果**: 
  - 30秒以内に処理完了
  - メモリ使用量が適切
  - UIがブロックされない

#### TC-013: 空データの処理
- **目的**: データが存在しない場合の処理
- **入力**: 空のデータセット
- **期待結果**: 
  - ヘッダーのみのCSVが生成される
  - エラーが発生しない
  - 適切なメッセージが表示される

#### TC-014: フィルタ結果が空の場合
- **目的**: フィルタリング後にデータが0件になる場合
- **入力**: 該当データがないフィルタ条件
- **期待結果**: 
  - 適切な警告メッセージが表示される
  - エクスポート続行の確認が行われる
  - ヘッダーのみのCSVが生成される

### 4. プログレス表示機能テスト

#### TC-015: プログレスの初期化
- **目的**: エクスポート開始時のプログレス状態
- **入力**: エクスポート開始リクエスト
- **期待結果**: 
  - プログレス 0% で開始
  - 現在フェーズが「準備中」
  - キャンセル可能状態

#### TC-016: プログレスの更新
- **目的**: 処理進行に伴うプログレス更新
- **入力**: 処理進行イベント
- **期待結果**: 
  - パーセンテージが正しく更新される
  - 現在フェーズが適切に表示される
  - 推定残り時間が算出される

#### TC-017: フェーズ遷移
- **目的**: 処理フェーズの正しい遷移
- **入力**: 各処理段階の完了イベント
- **期待結果**: 
  - 準備中 → データ取得 → 変換 → 生成 → ダウンロード
  - 各フェーズが順序通りに遷移
  - フェーズ名が正しく表示される

#### TC-018: プログレス完了
- **目的**: エクスポート完了時の状態更新
- **入力**: エクスポート完了イベント
- **期待結果**: 
  - プログレス 100% に達する
  - 完了メッセージが表示される
  - 成功統計情報が表示される

### 5. キャンセル機能テスト

#### TC-019: エクスポートキャンセル（準備段階）
- **目的**: 処理開始前のキャンセル機能
- **入力**: 準備段階でのキャンセルリクエスト
- **期待結果**: 
  - 処理が即座に中止される
  - リソースが適切に解放される
  - 初期状態に戻る

#### TC-020: エクスポートキャンセル（処理中）
- **目的**: 処理実行中のキャンセル機能
- **入力**: データ変換中のキャンセルリクエスト
- **期待結果**: 
  - 処理が安全に中断される
  - 一時ファイルがクリーンアップされる
  - キャンセル完了メッセージが表示される

#### TC-021: キャンセル後の再実行
- **目的**: キャンセル後の正常な再実行
- **入力**: キャンセル後の新しいエクスポートリクエスト
- **期待結果**: 
  - 新しいエクスポートが正常に開始される
  - 前回の状態が影響しない
  - プログレスが正しく初期化される

### 6. ファイル名生成機能テスト

#### TC-022: デフォルトファイル名
- **目的**: 基本的なファイル名の自動生成
- **入力**: デフォルトテンプレート
- **期待結果**: 
  - `driving-log-YYYY-MM-DD.csv` 形式
  - 現在日付が正しく挿入される
  - ファイル名が有効である

#### TC-023: 期間指定ファイル名
- **目的**: 期間フィルタ使用時のファイル名
- **入力**: 開始日・終了日を含む設定
- **期待結果**: 
  - `driving-log-START-END.csv` 形式
  - 両方の日付が正しく挿入される
  - 日付フォーマットが統一される

#### TC-024: フィルタ条件付きファイル名
- **目的**: フィルタリング時の説明的ファイル名
- **入力**: ステータスフィルタ等を含む設定
- **期待結果**: 
  - フィルタ条件がファイル名に反映される
  - 可読性の高いファイル名
  - ファイルシステム制限を遵守

#### TC-025: カスタムテンプレート
- **目的**: ユーザー定義テンプレートの適用
- **入力**: カスタムファイル名テンプレート
- **期待結果**: 
  - テンプレート変数が正しく置換される
  - 不正な文字が適切に処理される
  - テンプレートエラーの適切な処理

#### TC-026: ファイル名衝突回避
- **目的**: 同名ファイルの重複防止
- **入力**: 既存と同じファイル名
- **期待結果**: 
  - 連番付きファイル名が生成される
  - 元のファイル名が保持される
  - 拡張子が正しく維持される

### 7. ダウンロード機能テスト

#### TC-027: 基本ダウンロード
- **目的**: CSVファイルの正常なダウンロード
- **入力**: 生成されたCSVデータ
- **期待結果**: 
  - ブラウザのダウンロード機能が起動
  - 正しいMIMEタイプが設定される
  - ファイルサイズが正確

#### TC-028: 大容量ファイルダウンロード
- **目的**: 大きなCSVファイルのダウンロード
- **入力**: 50MB超のCSVデータ
- **期待結果**: 
  - ダウンロードが正常に完了する
  - メモリ使用量が適切
  - プログレス表示が機能する

#### TC-029: ダウンロード完了通知
- **目的**: ダウンロード成功の通知機能
- **入力**: ダウンロード完了イベント
- **期待結果**: 
  - 成功メッセージが表示される
  - ファイル情報（サイズ、レコード数）が表示される
  - ダウンロード履歴が記録される

#### TC-030: ダウンロード失敗処理
- **目的**: ダウンロードエラー時の処理
- **入力**: ダウンロード失敗シナリオ
- **期待結果**: 
  - エラーメッセージが表示される
  - 再試行オプションが提供される
  - 代替ダウンロード方法が提案される

### 8. エラーハンドリングテスト

#### TC-031: データ取得エラー
- **目的**: Storage Service エラー時の処理
- **入力**: データベース接続エラー
- **期待結果**: 
  - 適切なエラーメッセージが表示される
  - 処理が安全に中断される
  - 再試行オプションが提供される

#### TC-032: CSV生成エラー
- **目的**: CSV Service エラー時の処理
- **入力**: データ変換エラー
- **期待結果**: 
  - エラーの詳細が表示される
  - 問題のあるデータが特定される
  - 設定見直しの提案が行われる

#### TC-033: ブラウザ制限エラー
- **目的**: ブラウザ制限による失敗の処理
- **入力**: メモリ不足、ファイルサイズ制限等
- **期待結果**: 
  - 制限の説明が表示される
  - 分割エクスポートが提案される
  - 設定調整のヒントが提供される

#### TC-034: ネットワークエラー
- **目的**: ネットワーク問題による失敗の処理
- **入力**: オフライン状態、接続タイムアウト
- **期待結果**: 
  - ネットワーク状態が確認される
  - オフライン対応の説明が表示される
  - 再接続後の自動再試行

#### TC-035: 回復可能エラーの再試行
- **目的**: 一時的エラーからの自動回復
- **入力**: 一時的なサービスエラー
- **期待結果**: 
  - 自動再試行が実行される
  - 再試行回数が制限される
  - 最終的に手動再試行オプションが提供される

### 9. 状態管理テスト

#### TC-036: エクスポート状態の追跡
- **目的**: 現在のエクスポート状態の正確な管理
- **入力**: 各種状態変更イベント
- **期待結果**: 
  - 状態が正確に追跡される
  - 状態遷移が正しく行われる
  - 不正な状態遷移が防止される

#### TC-037: 複数エクスポートの制御
- **目的**: 同時エクスポートの制限機能
- **入力**: エクスポート実行中の新しいリクエスト
- **期待結果**: 
  - 同時実行が適切に制限される
  - 待機キューが管理される
  - 進行中エクスポートの優先度維持

#### TC-038: 状態の永続化
- **目的**: ブラウザリロード時の状態復元
- **入力**: ページリロード、タブ切り替え
- **期待結果**: 
  - 進行中の処理が適切に処理される
  - 設定が保持される
  - 必要に応じて処理が再開される

### 10. Web Worker 統合テスト

#### TC-039: Worker での処理実行
- **目的**: バックグラウンドでのエクスポート処理
- **入力**: Web Worker 利用設定
- **期待結果**: 
  - メインスレッドがブロックされない
  - Worker との通信が正常に動作
  - エラーが適切に伝達される

#### TC-040: Worker エラーハンドリング
- **目的**: Worker 内エラーの処理
- **入力**: Worker 実行時エラー
- **期待結果**: 
  - エラーがメインスレッドに伝達される
  - Worker が適切に終了される
  - フォールバック処理が実行される

#### TC-041: Worker キャンセル
- **目的**: Worker 実行中のキャンセル
- **入力**: Worker 処理中のキャンセルリクエスト
- **期待結果**: 
  - Worker が安全に終了される
  - リソースが適切に解放される
  - キャンセル完了が通知される

### 11. 統合テスト

#### TC-042: エンドツーエンドエクスポート
- **目的**: 設定からダウンロードまでの全工程
- **入力**: 完全なエクスポートフロー
- **期待結果**: 
  - 全ての工程が正常に動作
  - データの整合性が保たれる
  - ユーザー体験が良好

#### TC-043: 複数設定での連続エクスポート
- **目的**: 異なる設定での連続実行
- **入力**: 複数の異なるエクスポート設定
- **期待結果**: 
  - 各設定が正しく適用される
  - 設定間の干渉がない
  - メモリリークが発生しない

#### TC-044: プリセット利用フロー
- **目的**: プリセット保存から利用までの流れ
- **入力**: プリセット作成→保存→読み込み→実行
- **期待結果**: 
  - プリセットが正確に保存される
  - 保存した設定が正確に復元される
  - エクスポートが期待通りに実行される

### 12. パフォーマンステスト

#### TC-045: レスポンス時間測定
- **目的**: UI操作のレスポンス性確認
- **入力**: 各種UI操作（設定変更、ボタンクリック等）
- **期待結果**: 
  - 設定変更: 0.5秒以内
  - エクスポート開始: 2秒以内
  - プログレス更新: 1秒間隔

#### TC-046: メモリ使用量測定
- **目的**: メモリ効率の確認
- **入力**: 各種サイズのデータセット
- **期待結果**: 
  - 小量データ: 50MB以下
  - 中量データ: 100MB以下
  - 大量データ: 150MB以下

#### TC-047: 同時ユーザー負荷
- **目的**: 複数タブでの同時利用
- **入力**: 複数タブでの同時エクスポート
- **期待結果**: 
  - パフォーマンス劣化が最小限
  - リソースの適切な共有
  - 設定の競合がない

### 13. ブラウザ互換性テスト

#### TC-048: Chrome での動作確認
- **目的**: Chrome ブラウザでの完全な動作
- **入力**: 全機能の実行
- **期待結果**: 
  - 全機能が正常動作
  - パフォーマンス要件達成
  - UI表示が正常

#### TC-049: Firefox での動作確認
- **目的**: Firefox ブラウザでの動作確認
- **入力**: 全機能の実行
- **期待結果**: 
  - 基本機能が正常動作
  - ダウンロード機能が正常
  - 既知の制限事項の適切な処理

#### TC-050: Safari での動作確認
- **目的**: Safari ブラウザでの動作確認
- **入力**: 全機能の実行
- **期待結果**: 
  - 基本機能が動作
  - 制限事項の適切な説明
  - 代替手段の提供

#### TC-051: Edge での動作確認
- **目的**: Edge ブラウザでの動作確認
- **入力**: 全機能の実行
- **期待結果**: 
  - 全機能が正常動作
  - Legacy Edge の対応状況確認

## モックデータ

### 基本テストデータ
```typescript
const mockExportSettings: ExportSettings = {
  fields: [ExportField.ID, ExportField.DATE, ExportField.START_LOCATION_NAME, ExportField.TOTAL_DISTANCE],
  excludeFields: [ExportField.DRIVER_NAME],
  filters: {
    dateRange: {
      startDate: new Date('2024-01-01'),
      endDate: new Date('2024-01-31')
    },
    status: [DrivingLogStatus.COMPLETED]
  },
  format: {
    delimiter: ',',
    encoding: 'utf-8',
    lineEnding: '\n',
    quote: 'minimal',
    dateFormat: 'YYYY-MM-DD',
    timeFormat: 'HH:mm',
    numberFormat: {
      decimalPlaces: 2,
      thousandSeparator: false,
      distanceUnit: 'km',
      durationUnit: 'minutes'
    }
  },
  privacy: {
    anonymizeDriverName: false,
    anonymizeVehicleNumber: false,
    excludeGPSCoordinates: false,
    maskSensitiveLocations: false,
    coordinatePrecision: 4
  },
  fileNameTemplate: 'driving-log-{YYYY-MM-DD}.csv'
};

const mockPreset: ExportPreset = {
  id: 'preset-001',
  name: '標準エクスポート',
  description: '最も一般的な設定でのエクスポート',
  settings: mockExportSettings,
  isDefault: true,
  createdAt: new Date('2024-01-15'),
  lastUsed: new Date('2024-01-20')
};
```

### 大量データ
```typescript
const mockLargeDataset = Array.from({ length: 3000 }, (_, i) => ({
  id: `large-${i}`,
  date: new Date(Date.now() - i * 24 * 60 * 60 * 1000),
  startLocation: { name: `地点${i}` },
  endLocation: { name: `到着地${i}` },
  totalDistance: Math.random() * 100,
  status: [DrivingLogStatus.COMPLETED, DrivingLogStatus.IN_PROGRESS][i % 2]
}));
```

### エラーテスト用データ
```typescript
const mockErrorScenarios = {
  storageError: new Error('Storage service unavailable'),
  csvError: new Error('Invalid data format'),
  downloadError: new Error('Download failed'),
  networkError: new Error('Network connection lost')
};
```

## テスト実行計画

### Phase 1: コア機能テスト（2-3日）
- 設定管理（TC-001 ～ TC-004）
- 基本エクスポート（TC-010 ～ TC-014）
- エラーハンドリング（TC-031 ～ TC-035）

### Phase 2: 拡張機能テスト（2-3日）
- プリセット管理（TC-005 ～ TC-009）
- プログレス・キャンセル（TC-015 ～ TC-021）
- ファイル管理（TC-022 ～ TC-030）

### Phase 3: 統合・パフォーマンステスト（1-2日）
- 統合テスト（TC-042 ～ TC-044）
- パフォーマンステスト（TC-045 ～ TC-047）
- ブラウザ互換性（TC-048 ～ TC-051）

## 成功基準

### テストカバレッジ
- **ユニットテスト**: 90%以上
- **統合テスト**: 主要フロー100%カバー
- **エラーハンドリング**: 全エラーケースのテスト

### パフォーマンス
- **レスポンス時間**: 要件内での動作
- **メモリ使用量**: 制限内での動作
- **大量データ処理**: 安定した動作

### 品質
- **全テストケース**: PASS
- **ブラウザ互換性**: 主要ブラウザでの動作確認
- **ユーザビリティ**: 直感的な操作の確認