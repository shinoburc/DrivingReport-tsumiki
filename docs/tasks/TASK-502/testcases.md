# TASK-502: 運転記録画面実装 - テストケース設計

## テストケース一覧

### 1. RecordingScreen コンポーネント基本テスト

#### TC-001: 基本レンダリング
- **目的**: 記録画面の基本構造が正しく表示される
- **前提条件**: コンポーネントが正常にマウントされる
- **テスト手順**:
  1. RecordingScreen コンポーネントをレンダリング
  2. 各セクションの存在確認
- **期待結果**:
  - RecordingHeader が表示される
  - GPSIndicator が表示される
  - MainControls が表示される
  - StatisticsPanel が表示される
  - WaypointSection が表示される

#### TC-002: プロパティ受け渡し
- **目的**: props が正しく子コンポーネントに渡される
- **入力**: `{ className: 'custom-class', onRecordComplete: mockFunction }`
- **期待結果**:
  - カスタムクラスが適用される
  - コールバック関数が適切に設定される

#### TC-003: 初期状態の確認
- **目的**: 初期状態が正しく設定される
- **期待結果**:
  - isRecording が false で初期化される
  - isPaused が false で初期化される
  - elapsedTime が 0 で初期化される
  - waypoints が空配列で初期化される
  - errors が空配列で初期化される

### 2. 記録制御機能テスト

#### TC-004: 記録開始機能
- **目的**: 記録開始ボタンが正しく動作する
- **前提条件**: 記録が開始されていない状態
- **テスト手順**:
  1. 記録開始ボタンをクリック
  2. GPS位置取得の開始確認
  3. 状態変更の確認
- **期待結果**:
  - isRecording が true になる
  - startTime が設定される
  - GPS監視が開始される
  - タイマーが開始される

#### TC-005: 記録一時停止機能
- **目的**: 記録一時停止ボタンが正しく動作する
- **前提条件**: 記録が進行中の状態
- **テスト手順**:
  1. 一時停止ボタンをクリック
  2. GPS監視の停止確認
  3. 状態変更の確認
- **期待結果**:
  - isPaused が true になる
  - GPS監視が停止される
  - タイマーが停止される
  - 一時停止時刻が記録される

#### TC-006: 記録再開機能
- **目的**: 記録再開ボタンが正しく動作する
- **前提条件**: 記録が一時停止中の状態
- **テスト手順**:
  1. 再開ボタンをクリック
  2. GPS監視の再開確認
  3. 状態変更の確認
- **期待結果**:
  - isPaused が false になる
  - GPS監視が再開される
  - タイマーが再開される

#### TC-007: 記録完了機能
- **目的**: 記録完了ボタンが正しく動作する
- **前提条件**: 記録が進行中または一時停止中の状態
- **テスト手順**:
  1. 完了ボタンをクリック
  2. 確認ダイアログの表示確認
  3. 記録データの保存確認
  4. コールバック関数の呼び出し確認
- **期待結果**:
  - 記録データが正しく生成される
  - データが保存される
  - onRecordComplete が呼び出される
  - 記録状態がリセットされる

#### TC-008: 記録キャンセル機能
- **目的**: 記録キャンセルボタンが正しく動作する
- **前提条件**: 記録が進行中の状態
- **テスト手順**:
  1. キャンセルボタンをクリック
  2. 確認ダイアログの表示確認
  3. 記録データの破棄確認
  4. コールバック関数の呼び出し確認
- **期待結果**:
  - 記録データが破棄される
  - onRecordCancel が呼び出される
  - 記録状態がリセットされる

### 3. GPS機能テスト

#### TC-009: GPS状態表示
- **目的**: GPS状態が正しく表示される
- **テストデータ**:
  - GPS利用可能: 緑色インジケーター
  - GPS取得中: 黄色インジケーター
  - GPS精度不良: 赤色インジケーター
  - GPS利用不可: グレーインジケーター
- **期待結果**: 各状態に対応した色とアイコンが表示される

#### TC-010: GPS精度表示
- **目的**: GPS精度が正しく表示される
- **テストデータ**:
  ```typescript
  {
    accuracy: 5.2,
    signal: 'excellent',
    lastUpdate: new Date()
  }
  ```
- **期待結果**:
  - 精度が「5.2m」として表示される
  - 信号強度が「excellent」として表示される
  - 最終更新時刻が表示される

#### TC-011: 位置情報更新
- **目的**: 位置情報がリアルタイムで更新される
- **テスト手順**:
  1. GPS監視を開始
  2. 模擬位置情報を送信
  3. 画面表示の更新確認
- **期待結果**:
  - 位置情報が3秒以内に更新される
  - 座標表示が新しい値に変わる
  - 統計情報が再計算される

#### TC-012: GPS エラーハンドリング
- **目的**: GPS関連エラーが適切に処理される
- **テストシナリオ**:
  - GPS権限拒否
  - GPS機能無効
  - GPS精度不良
- **期待結果**: 各エラーに対応したメッセージが表示される

### 4. 統計情報表示テスト

#### TC-013: 経過時間表示
- **目的**: 経過時間が正しく表示される
- **テストデータ**: 記録開始から90分経過
- **期待結果**:
  - 「01:30:00」形式で表示される
  - リアルタイムで更新される
  - 一時停止中は更新されない

#### TC-014: 走行距離計算
- **目的**: 走行距離が正しく計算・表示される
- **テストデータ**: 複数の位置情報ポイント
- **期待結果**:
  - 実際の移動距離が計算される
  - 単位「km」で表示される
  - 小数点以下1桁まで表示される

#### TC-015: 速度計算
- **目的**: 平均速度・最高速度が正しく計算される
- **テストデータ**: 時間と距離データ
- **期待結果**:
  - 平均速度が正しく計算される
  - 最高速度が記録される
  - 単位「km/h」で表示される

#### TC-016: 停止時間計算
- **目的**: 停止時間が正しく計算される
- **テスト手順**:
  1. 記録を開始
  2. 一時停止を実行
  3. 一定時間待機
  4. 再開を実行
- **期待結果**:
  - 一時停止中の時間が停止時間に加算される
  - 移動時間と停止時間の合計が経過時間と一致する

### 5. ウェイポイント機能テスト

#### TC-017: ウェイポイント追加
- **目的**: ウェイポイントが正しく追加される
- **テスト手順**:
  1. 「地点追加」ボタンをクリック
  2. 地点名とタイプを設定
  3. 保存ボタンをクリック
- **期待結果**:
  - 現在位置がウェイポイントとして追加される
  - 地点名とタイプが正しく設定される
  - ウェイポイントリストに表示される

#### TC-018: ウェイポイント編集
- **目的**: ウェイポイントの編集が正しく動作する
- **テスト手順**:
  1. 既存ウェイポイントをクリック
  2. 名前を変更
  3. タイプを変更
  4. 保存ボタンをクリック
- **期待結果**:
  - 名前とタイプが更新される
  - 変更がリストに反映される

#### TC-019: ウェイポイント削除
- **目的**: ウェイポイントの削除が正しく動作する
- **テスト手順**:
  1. ウェイポイントの削除ボタンをクリック
  2. 確認ダイアログで削除を確認
- **期待結果**:
  - ウェイポイントがリストから削除される
  - データからも削除される

#### TC-020: クイックアクション
- **目的**: クイックアクションボタンが正しく動作する
- **テスト手順**:
  1. 「給油」ボタンをクリック
  2. 自動的にウェイポイントが追加されることを確認
- **期待結果**:
  - タイプ「fuel」のウェイポイントが追加される
  - デフォルト名「給油」が設定される

### 6. useRecording フック テスト

#### TC-021: 初期化
- **目的**: フックの初期状態が正しく設定される
- **期待結果**:
  - isRecording が false で開始される
  - 空の配列・初期値が設定される
  - アクション関数が定義される

#### TC-022: 記録制御
- **目的**: 記録制御機能の確認
- **テスト手順**:
  1. startRecording() を呼び出し
  2. DrivingLogController の呼び出し確認
- **期待結果**:
  - コントローラーが正しく呼び出される
  - 成功時に状態が更新される

#### TC-023: 位置情報監視
- **目的**: GPS位置監視機能の確認
- **テスト手順**:
  1. 記録開始
  2. 位置情報の更新確認
  3. 監視停止の確認
- **期待結果**:
  - 位置情報が定期的に更新される
  - 記録停止時に監視が停止される

#### TC-024: 統計計算機能
- **目的**: リアルタイム統計計算の確認
- **テスト手順**:
  1. 複数の位置情報を送信
  2. 統計情報の更新確認
- **期待結果**:
  - 距離・速度が正しく計算される
  - 統計情報がリアルタイムで更新される

#### TC-025: エラー処理
- **目的**: エラー時の適切な処理確認
- **テストシナリオ**:
  - GPS取得エラー
  - 保存エラー
  - 権限エラー
- **期待結果**: 各エラーに対応したメッセージが表示される

### 7. レスポンシブデザイン テスト

#### TC-026: スマートフォン表示（320px-480px）
- **目的**: スマートフォンでの適切な表示確認
- **テスト環境**: 320px、375px、480px幅
- **期待結果**:
  - 縦並びレイアウト
  - タップ領域60px以上
  - 横スクロール無し
  - 片手操作対応

#### TC-027: タブレット表示（481px-768px）
- **目的**: タブレットでの適切な表示確認
- **テスト環境**: 600px、768px幅
- **期待結果**:
  - 詳細情報の追加表示
  - 適切な余白とスペーシング
  - 読みやすいフォントサイズ

#### TC-028: 横画面表示
- **目的**: 横画面での適切な表示確認
- **テスト手順**:
  1. 縦画面で表示確認
  2. 横画面に回転
  3. レイアウト調整の確認
- **期待結果**: 横画面用レイアウトが適用される

#### TC-029: 大きなタッチターゲット
- **目的**: 運転中操作に適したタッチターゲット確認
- **測定項目**: ボタンサイズ
- **期待結果**:
  - メインボタンが60x60px以上
  - セカンダリボタンが44x44px以上
  - 十分な間隔が確保される

### 8. アクセシビリティ テスト

#### TC-030: セマンティックHTML
- **目的**: 適切なHTML要素の使用確認
- **確認項目**:
  - header要素の使用
  - main要素の使用
  - section要素の使用
  - button要素の使用
- **期待結果**: セマンティックな構造が実装される

#### TC-031: ARIA属性
- **目的**: 適切なARIA属性の設定確認
- **確認項目**:
  - aria-label の設定
  - aria-live領域の設定
  - role属性の設定
  - aria-expanded の設定
- **期待結果**: スクリーンリーダーで適切に読み上げられる

#### TC-032: キーボードナビゲーション
- **目的**: キーボードでの操作確認
- **テスト手順**:
  1. Tabキーでフォーカス移動
  2. Enterキーでボタン実行
  3. 矢印キーでリスト移動
- **期待結果**: 全機能がキーボードで操作可能

#### TC-033: フォーカス管理
- **目的**: フォーカスの適切な管理確認
- **確認項目**:
  - 初期フォーカス位置
  - フォーカス移動順序
  - フォーカス表示の明確性
- **期待結果**: 論理的なフォーカス移動が実現される

#### TC-034: カラーコントラスト
- **目的**: 十分なコントラスト比の確認
- **確認項目**:
  - 通常テキスト: 4.5:1以上
  - 大きなテキスト: 3:1以上
  - ボタン・アイコン: 3:1以上
- **期待結果**: WCAG AA基準を満たす

### 9. パフォーマンス テスト

#### TC-035: 初期レンダリング性能
- **目的**: 初期表示時間の確認
- **測定項目**:
  - First Contentful Paint (FCP)
  - Time to Interactive (TTI)
- **期待結果**:
  - FCP: 1秒以下
  - TTI: 2秒以下

#### TC-036: GPS更新性能
- **目的**: GPS更新時の性能確認
- **測定項目**:
  - 位置更新処理時間
  - 統計計算時間
  - UI更新時間
- **期待結果**:
  - 位置更新: 3秒以下
  - 統計計算: 0.5秒以下
  - UI更新: 0.1秒以下

#### TC-037: メモリ使用量
- **目的**: メモリ使用量の確認
- **測定項目**:
  - 初期メモリ使用量
  - 1時間記録時のメモリ使用量
  - メモリリークの有無
- **期待結果**:
  - 初期: 50MB以下
  - 1時間後: 70MB以下
  - メモリリーク: 無し

#### TC-038: バッテリー消費
- **目的**: バッテリー消費の確認
- **測定条件**: 1時間の連続記録
- **期待結果**: 5%以下の消費

### 10. エラーハンドリング テスト

#### TC-039: GPS権限エラー
- **目的**: GPS権限拒否時の処理確認
- **シミュレーション**: navigator.geolocation.getCurrentPosition エラー
- **期待結果**:
  - 適切なエラーメッセージ表示
  - 権限再要求オプションの提供
  - 代替手段の提示

#### TC-040: GPS精度不良エラー
- **目的**: GPS精度不良時の処理確認
- **シミュレーション**: 高い accuracy 値の position データ
- **期待結果**:
  - GPS状態インジケーターが警告色に変化
  - 精度改善のアドバイス表示
  - 記録継続可能

#### TC-041: ストレージエラー
- **目的**: ストレージ関連エラーの処理確認
- **シミュレーション**: QuotaExceededError の発生
- **期待結果**:
  - 容量不足の警告表示
  - データクリーンアップの提案
  - 記録の緊急保存

#### TC-042: ネットワークエラー
- **目的**: ネットワーク関連エラーの処理確認
- **シミュレーション**: navigator.onLine = false
- **期待結果**:
  - オフライン状態の表示
  - ローカル保存の継続
  - 再接続時の同期準備

### 11. 統合テスト

#### TC-043: エンドツーエンドフロー
- **目的**: 一連の記録フローの確認
- **テスト手順**:
  1. 記録画面アクセス
  2. 記録開始ボタンクリック
  3. 複数のウェイポイント追加
  4. 記録完了
  5. データ保存確認
- **期待結果**: 全フローが正常に完了する

#### TC-044: バックグラウンド動作
- **目的**: バックグラウンド実行の確認
- **テスト手順**:
  1. 記録開始
  2. アプリをバックグラウンドに移動
  3. 一定時間経過後にアプリを再表示
  4. 記録継続の確認
- **期待結果**: バックグラウンド中も記録が継続される

#### TC-045: 画面遷移
- **目的**: 他画面との連携確認
- **テスト手順**:
  1. 記録画面表示
  2. ダッシュボードに遷移
  3. 記録画面に戻る
  4. 記録状態の保持確認
- **期待結果**: 記録状態が正しく保持される

#### TC-046: データ整合性
- **目的**: 保存データの整合性確認
- **テスト手順**:
  1. 記録完了
  2. 保存されたデータの検証
  3. 他画面での表示確認
- **期待結果**: データが正確に保存・表示される

### 12. セキュリティ・プライバシー テスト

#### TC-047: 位置情報暗号化
- **目的**: 位置情報の暗号化確認
- **確認項目**:
  - ローカルストレージでの暗号化
  - メモリ上での暗号化
  - 転送時の暗号化
- **期待結果**: 位置情報が適切に暗号化される

#### TC-048: データ漏洩防止
- **目的**: 意図しないデータ漏洩の防止確認
- **確認項目**:
  - console.log での出力防止
  - エラーメッセージでの情報漏洩防止
  - デバッグ情報の適切な制御
- **期待結果**: 機密情報が漏洩しない

#### TC-049: データ削除
- **目的**: データ削除機能の確認
- **テスト手順**:
  1. 記録データを作成
  2. 削除機能を実行
  3. データの完全削除確認
- **期待結果**: データが完全に削除される

#### TC-050: 権限管理
- **目的**: 必要最小限の権限使用確認
- **確認項目**:
  - 位置情報権限の適切な使用
  - ストレージ権限の必要時のみ使用
  - カメラ・マイク権限の未使用確認
- **期待結果**: 必要最小限の権限のみ使用

## モックデータ

### 基本テストデータ
```typescript
const mockRecordingState: RecordingState = {
  isRecording: true,
  isPaused: false,
  startTime: new Date('2024-08-15T09:00:00'),
  elapsedTime: 5400, // 90 minutes
  currentLocation: {
    id: 'loc-current',
    name: '現在地',
    latitude: 35.6812,
    longitude: 139.7671,
    timestamp: new Date(),
    type: LocationType.CURRENT
  },
  gpsStatus: {
    isAvailable: true,
    accuracy: 5.2,
    signal: 'excellent',
    lastUpdate: new Date()
  },
  waypoints: [
    {
      id: 'wp-001',
      location: {
        id: 'loc-start',
        name: '出発地',
        latitude: 35.6580,
        longitude: 139.7016,
        timestamp: new Date('2024-08-15T09:00:00'),
        type: LocationType.START
      },
      timestamp: new Date('2024-08-15T09:00:00'),
      name: '自宅',
      type: 'start',
      notes: ''
    },
    {
      id: 'wp-002',
      location: {
        id: 'loc-fuel',
        name: '給油所',
        latitude: 35.6650,
        longitude: 139.7300,
        timestamp: new Date('2024-08-15T09:30:00'),
        type: LocationType.WAYPOINT
      },
      timestamp: new Date('2024-08-15T09:30:00'),
      name: 'エネオス中央店',
      type: 'fuel',
      notes: ''
    }
  ],
  statistics: {
    distance: 12.5,
    averageSpeed: 35.2,
    maxSpeed: 60.0,
    stopTime: 300, // 5 minutes
    movingTime: 5100 // 85 minutes
  },
  errors: []
};

const mockGPSStatuses = {
  excellent: {
    isAvailable: true,
    accuracy: 3.0,
    signal: 'excellent' as const,
    lastUpdate: new Date()
  },
  good: {
    isAvailable: true,
    accuracy: 8.0,
    signal: 'good' as const,
    lastUpdate: new Date()
  },
  fair: {
    isAvailable: true,
    accuracy: 25.0,
    signal: 'fair' as const,
    lastUpdate: new Date()
  },
  poor: {
    isAvailable: true,
    accuracy: 80.0,
    signal: 'poor' as const,
    lastUpdate: new Date()
  },
  none: {
    isAvailable: false,
    accuracy: 0,
    signal: 'none' as const,
    lastUpdate: new Date()
  }
};

const mockErrors: RecordingError[] = [
  {
    type: 'GPS',
    message: 'GPS信号を取得できません',
    recoverable: true,
    action: () => console.log('GPS再試行')
  },
  {
    type: 'STORAGE',
    message: 'ストレージ容量が不足しています',
    recoverable: true,
    action: () => console.log('容量クリーンアップ')
  },
  {
    type: 'BATTERY',
    message: 'バッテリー残量が少なくなっています',
    recoverable: false
  },
  {
    type: 'NETWORK',
    message: 'ネットワークに接続できません',
    recoverable: false
  }
];
```

### GPS位置更新データ
```typescript
const mockLocationUpdates = [
  {
    timestamp: new Date('2024-08-15T09:00:00'),
    latitude: 35.6580,
    longitude: 139.7016,
    accuracy: 5.0,
    speed: 0
  },
  {
    timestamp: new Date('2024-08-15T09:05:00'),
    latitude: 35.6600,
    longitude: 139.7050,
    accuracy: 4.5,
    speed: 25.2
  },
  {
    timestamp: new Date('2024-08-15T09:10:00'),
    latitude: 35.6620,
    longitude: 139.7080,
    accuracy: 6.0,
    speed: 35.8
  },
  {
    timestamp: new Date('2024-08-15T09:15:00'),
    latitude: 35.6650,
    longitude: 139.7120,
    accuracy: 8.0,
    speed: 0 // 停車
  }
];
```

## テスト実行計画

### Phase 1: ユニットテスト（3-4日）
- コンポーネント単体テスト（TC-001 ～ TC-025）
- フック単体テスト
- GPS機能テスト
- 基本的なレスポンシブテスト

### Phase 2: 統合テスト（2-3日）
- GPS統合テスト（TC-039 ～ TC-042）
- ストレージ統合テスト
- エラーハンドリングテスト
- パフォーマンステスト（TC-035 ～ TC-038）

### Phase 3: E2E・品質テスト（2日）
- エンドツーエンドテスト（TC-043 ～ TC-046）
- アクセシビリティテスト（TC-030 ～ TC-034）
- セキュリティテスト（TC-047 ～ TC-050）
- ブラウザ互換性テスト

## 成功基準

### テストカバレッジ
- **ユニットテスト**: 90%以上
- **統合テスト**: 主要フロー100%カバー
- **E2Eテスト**: クリティカルパス100%カバー

### パフォーマンス
- **初期表示**: 1秒以内
- **GPS更新**: 3秒以内
- **操作反応**: 0.5秒以内

### アクセシビリティ
- **WCAG 2.1 AA**: 100%準拠
- **キーボード操作**: 全機能対応
- **スクリーンリーダー**: 完全対応

### 品質
- **全テストケース**: PASS
- **運転中操作**: 安全性確認
- **レスポンシブ**: 全ブレークポイント対応