# TASK-401: CSV Service Implementation - テストケース設計

## テストケース一覧

### 1. 基本CSV生成機能テスト

#### TC-001: 基本CSV生成
- **目的**: 運転日報データを正常にCSV変換できることを確認
- **入力**: 1件のDrivingLogModelデータ
- **期待結果**: 
  - 正しいCSVヘッダーが生成される
  - データ行が正確に変換される
  - UTF-8エンコーディング

#### TC-002: 複数データCSV生成
- **目的**: 複数の運転日報データのCSV変換
- **入力**: 10件のDrivingLogModelデータ配列
- **期待結果**: 
  - ヘッダー + 10行のデータ
  - データの順序が保持される
  - 全フィールドが正確に変換

#### TC-003: 空データの処理
- **目的**: 空配列の場合の処理確認
- **入力**: 空の配列 []
- **期待結果**: 
  - ヘッダーのみのCSVが生成される
  - エラーが発生しない

#### TC-004: BOM付きCSV生成
- **目的**: Excel対応のBOM付きCSV生成
- **入力**: データ + BOMオプション
- **期待結果**: 
  - ファイル先頭にBOM (EF BB BF) が付加される
  - Excelで文字化けしない

### 2. フィールド選択機能テスト

#### TC-005: 基本フィールド選択
- **目的**: 指定したフィールドのみエクスポート
- **入力**: データ + フィールド選択オプション
- **期待結果**: 
  - 選択したフィールドのみCSVに含まれる
  - ヘッダーも対応するフィールドのみ

#### TC-006: フィールド除外
- **目的**: 指定フィールドの除外機能
- **入力**: データ + excludeFieldsオプション
- **期待結果**: 
  - 除外フィールドがCSVに含まれない
  - 他のフィールドは正常に出力

#### TC-007: GPS座標の出力制御
- **目的**: GPS座標の出力/非出力制御
- **入力**: GPS座標を含むデータ + 座標出力オプション
- **期待結果**: 
  - オプションに従ってGPS座標が出力される/されない

#### TC-008: 不正フィールド指定
- **目的**: 存在しないフィールド指定時の処理
- **入力**: 存在しないフィールド名を指定
- **期待結果**: 
  - 適切なエラーメッセージ
  - 処理が中断される

### 3. データフィルタリング機能テスト

#### TC-009: 期間フィルタ
- **目的**: 指定期間内のデータのみエクスポート
- **入力**: 複数日のデータ + 期間指定
- **期待結果**: 
  - 指定期間内のデータのみCSVに含まれる

#### TC-010: ステータスフィルタ
- **目的**: 特定ステータスのデータのみエクスポート
- **入力**: 混在ステータスデータ + ステータス指定
- **期待結果**: 
  - 指定ステータスのデータのみ出力

#### TC-011: 距離範囲フィルタ
- **目的**: 指定距離範囲のデータのみエクスポート
- **入力**: 様々な距離のデータ + 距離範囲
- **期待結果**: 
  - 範囲内のデータのみ出力

#### TC-012: 複合フィルタ
- **目的**: 複数フィルタの組み合わせ
- **入力**: データ + 期間・ステータス・距離の複合フィルタ
- **期待結果**: 
  - すべての条件を満たすデータのみ出力

### 4. プライバシー保護機能テスト

#### TC-013: ドライバー名匿名化
- **目的**: ドライバー名の匿名化処理
- **入力**: ドライバー名を含むデータ + 匿名化オプション
- **期待結果**: 
  - "田中太郎" → "田中***" に変換
  - 元の名前が復元できない

#### TC-014: 車両番号匿名化
- **目的**: 車両番号の匿名化処理
- **入力**: 車両番号を含むデータ + 匿名化オプション
- **期待結果**: 
  - "品川123あ4567" → "***123***567" に変換

#### TC-015: GPS座標精度調整
- **目的**: GPS座標の精度を下げる処理
- **入力**: 高精度GPS座標 + 精度設定
- **期待結果**: 
  - 小数点以下の桁数が制限される
  - 位置の大まかな特定のみ可能

#### TC-016: 住所マスキング
- **目的**: 具体的住所の部分マスキング
- **入力**: 詳細住所データ + マスキングオプション
- **期待結果**: 
  - "東京都新宿区西新宿1-1-1" → "東京都新宿区***"

### 5. フォーマット機能テスト

#### TC-017: 区切り文字設定
- **目的**: CSV区切り文字の変更機能
- **入力**: データ + 区切り文字設定（カンマ、セミコロン、タブ）
- **期待結果**: 
  - 指定した区切り文字でCSVが生成される

#### TC-018: 文字エンコーディング
- **目的**: 文字エンコーディングの変更
- **入力**: 日本語データ + エンコーディング設定
- **期待結果**: 
  - UTF-8, Shift_JIS で正しくエンコードされる

#### TC-019: 改行コード設定
- **目的**: 改行コードの変更機能
- **入力**: データ + 改行コード設定（CRLF, LF）
- **期待結果**: 
  - 指定した改行コードでCSVが生成される

#### TC-020: クォート設定
- **目的**: フィールドのクォート処理設定
- **入力**: 特殊文字を含むデータ + クォート設定
- **期待結果**: 
  - all: 全フィールドがクォートされる
  - minimal: 必要な場合のみクォート
  - none: クォートなし

### 6. 日付・数値フォーマットテスト

#### TC-021: 日付フォーマット
- **目的**: 日付の表示形式変更
- **入力**: 日付データ + フォーマット設定
- **期待結果**: 
  - YYYY-MM-DD, YYYY/MM/DD, 和暦形式で正しく表示

#### TC-022: 時刻フォーマット
- **目的**: 時刻の表示形式変更
- **入力**: 時刻データ + フォーマット設定
- **期待結果**: 
  - HH:mm, HH:mm:ss 形式で正しく表示

#### TC-023: 数値フォーマット
- **目的**: 数値の表示形式変更
- **入力**: 距離・時間データ + フォーマット設定
- **期待結果**: 
  - 単位変換（km→m、分→時間）が正しく行われる
  - 小数点桁数が正しく制限される

#### TC-024: 3桁区切り
- **目的**: 数値の3桁区切り表示
- **入力**: 大きな数値 + 3桁区切り設定
- **期待結果**: 
  - カンマで3桁ごとに区切られる

### 7. パフォーマンステスト

#### TC-025: 少量データ処理
- **目的**: 100件未満のデータ処理性能
- **入力**: 50件のデータ
- **期待結果**: 
  - 1秒以内に処理完了
  - メモリ使用量が適切

#### TC-026: 中量データ処理
- **目的**: 1000件のデータ処理性能
- **入力**: 1000件のデータ
- **期待結果**: 
  - 5秒以内に処理完了
  - プログレス報告が正しく動作

#### TC-027: 大量データ処理
- **目的**: 3000件のデータ処理性能
- **入力**: 3000件のデータ
- **期待結果**: 
  - 10秒以内に処理完了
  - メモリ使用量100MB以下

#### TC-028: ストリーミング処理
- **目的**: メモリ効率的な大量データ処理
- **入力**: 10000件のデータ + ストリーミングオプション
- **期待結果**: 
  - メモリ使用量が一定に保たれる
  - 処理がブロックされない

### 8. Web Worker テスト

#### TC-029: Web Worker利用
- **目的**: バックグラウンド処理でのCSV生成
- **入力**: 大量データ + Web Workerオプション
- **期待結果**: 
  - UIがブロックされない
  - 処理完了通知が正しく届く

#### TC-030: Worker エラーハンドリング
- **目的**: Web Worker内でのエラー処理
- **入力**: エラーを発生させるデータ + Web Worker
- **期待結果**: 
  - エラーが適切にメインスレッドに伝達される
  - Workerが適切に終了する

#### TC-031: Worker キャンセル
- **目的**: 長時間処理のキャンセル機能
- **入力**: 大量データ + 処理中断指示
- **期待結果**: 
  - 処理が適切に中断される
  - リソースが適切に解放される

### 9. ブラウザAPI テスト

#### TC-032: Blob生成
- **目的**: CSVデータからBlobオブジェクト生成
- **入力**: CSVデータ
- **期待結果**: 
  - 正しいMIMEタイプのBlobが生成される
  - ファイルダウンロードが可能

#### TC-033: ダウンロードURL生成
- **目的**: ダウンロード用URLの生成
- **入力**: CSVBlob
- **期待結果**: 
  - 有効なダウンロードURLが生成される
  - URL解放が適切に行われる

#### TC-034: ファイル保存
- **目的**: 生成したCSVのファイル保存
- **入力**: CSVデータ + ファイル名
- **期待結果**: 
  - ブラウザのダウンロード機能で保存される
  - ファイル名が正しく設定される

### 10. エラーハンドリングテスト

#### TC-035: 不正データエラー
- **目的**: 不正な入力データでのエラー処理
- **入力**: null, undefined, 不正形式のデータ
- **期待結果**: 
  - 適切なエラーメッセージ
  - 処理が安全に停止

#### TC-036: メモリ不足エラー
- **目的**: メモリ不足時のエラー処理
- **入力**: 極大量のデータ
- **期待結果**: 
  - メモリエラーが適切に検出される
  - 代替処理または適切なエラー通知

#### TC-037: ブラウザ制限エラー
- **目的**: ブラウザ制限によるエラー処理
- **入力**: 制限を超えるデータサイズ
- **期待結果**: 
  - 制限エラーが適切に処理される
  - 分割処理の提案

#### TC-038: タイムアウトエラー
- **目的**: 処理タイムアウト時のエラー処理
- **入力**: 長時間処理 + タイムアウト設定
- **期待結果**: 
  - タイムアウトが適切に検出される
  - 部分的な結果の提供

### 11. データ整合性テスト

#### TC-039: 特殊文字処理
- **目的**: CSV内の特殊文字の適切な処理
- **入力**: カンマ、改行、クォートを含むデータ
- **期待結果**: 
  - 特殊文字が適切にエスケープされる
  - データの意味が保持される

#### TC-040: 多言語対応
- **目的**: 日本語以外の文字の処理
- **入力**: 英語、中国語、韓国語を含むデータ
- **期待結果**: 
  - 文字化けが発生しない
  - 正しくエンコードされる

#### TC-041: 長いテキスト処理
- **目的**: 長いテキストフィールドの処理
- **入力**: 1000文字以上のメモテキスト
- **期待結果**: 
  - 切り捨てなく正確に出力される
  - パフォーマンスが維持される

#### TC-042: 数値精度
- **目的**: 数値の精度保持確認
- **入力**: 高精度の緯度経度データ
- **期待結果**: 
  - 指定した小数点桁数で正確に出力
  - 丸め誤差が適切に処理

### 12. 統合テスト

#### TC-043: エンドツーエンド
- **目的**: データ取得からファイル保存までの全工程
- **入力**: StorageServiceからのデータ取得 → CSV生成 → ファイル保存
- **期待結果**: 
  - 全工程が正常に完了
  - データの整合性が保たれる

#### TC-044: 複数フォーマット同時生成
- **目的**: 異なるフォーマットでの同時生成
- **入力**: 同一データで複数のフォーマット設定
- **期待結果**: 
  - 各フォーマットが正しく生成される
  - 処理が競合しない

#### TC-045: 設定保存・復元
- **目的**: エクスポート設定の永続化
- **入力**: カスタム設定の保存・読み込み
- **期待結果**: 
  - 設定が正確に保存・復元される
  - デフォルト設定との切り替えが正常

### 13. ブラウザ互換性テスト

#### TC-046: Chrome対応
- **目的**: Chrome での動作確認
- **入力**: 各種機能の実行
- **期待結果**: 
  - 全機能が正常動作
  - パフォーマンス要件達成

#### TC-047: Firefox対応
- **目的**: Firefox での動作確認
- **入力**: 各種機能の実行
- **期待結果**: 
  - 全機能が正常動作
  - ダウンロード機能が正常

#### TC-048: Safari対応
- **目的**: Safari での動作確認
- **入力**: 各種機能の実行（iOSも含む）
- **期待結果**: 
  - 基本機能が動作
  - 制限事項が適切に処理

#### TC-049: Edge対応
- **目的**: Edge での動作確認
- **入力**: 各種機能の実行
- **期待結果**: 
  - 全機能が正常動作
  - 古いEdgeでの互換性

## モックデータ

### 基本テストデータ
```typescript
const mockBasicData: DrivingLogModel[] = [
  {
    id: 'log-001',
    date: new Date('2024-01-15'),
    startTime: new Date('2024-01-15T09:00:00'),
    endTime: new Date('2024-01-15T17:30:00'),
    driverName: '田中太郎',
    vehicleNumber: '品川123あ4567',
    startLocation: {
      id: 'loc-001',
      name: '東京駅',
      address: '東京都千代田区丸の内1-1-1',
      latitude: 35.6812,
      longitude: 139.7671,
      accuracy: 5,
      timestamp: new Date('2024-01-15T09:00:00'),
      type: LocationType.START
    },
    endLocation: {
      id: 'loc-002',
      name: '新宿駅',
      address: '東京都新宿区新宿3-38-1',
      latitude: 35.6896,
      longitude: 139.7006,
      accuracy: 8,
      timestamp: new Date('2024-01-15T17:30:00'),
      type: LocationType.END
    },
    waypoints: [],
    totalDistance: 12.5,
    duration: 510,
    purpose: '営業訪問',
    memo: '顧客との重要な会議のため',
    status: DrivingLogStatus.COMPLETED,
    createdAt: new Date('2024-01-15T09:00:00'),
    updatedAt: new Date('2024-01-15T17:30:00')
  }
];
```

### 特殊文字テストデータ
```typescript
const mockSpecialCharData: DrivingLogModel[] = [
  {
    id: 'log-special',
    date: new Date('2024-01-16'),
    startLocation: {
      name: 'カンマ,を含む地点',
      address: '改行\nを含む住所',
    },
    memo: 'ダブルクォート"を含むメモ',
    purpose: 'セミコロン;を含む目的',
    // ... その他のフィールド
  }
];
```

### 大量テストデータ
```typescript
const mockLargeData = Array.from({ length: 3000 }, (_, i) => ({
  id: `bulk-${i}`,
  date: new Date(Date.now() - i * 24 * 60 * 60 * 1000),
  startLocation: {
    name: `地点${i}`,
    latitude: 35.6762 + (i % 100) * 0.01,
    longitude: 139.6503 + (i % 100) * 0.01,
  },
  totalDistance: Math.random() * 100,
  duration: Math.random() * 480,
  status: [
    DrivingLogStatus.COMPLETED,
    DrivingLogStatus.IN_PROGRESS,
    DrivingLogStatus.CANCELLED
  ][i % 3],
  purpose: ['営業', '通勤', 'プライベート'][i % 3],
  memo: `テストメモ${i}`,
  // ... その他のフィールド
}));
```

### プライバシーテストデータ
```typescript
const mockPrivacyData: DrivingLogModel[] = [
  {
    id: 'privacy-001',
    driverName: '山田花子',
    vehicleNumber: '世田谷456う7890',
    startLocation: {
      name: '自宅',
      address: '東京都世田谷区桜新町1-2-3',
      latitude: 35.6234567,
      longitude: 139.6789012,
    },
    memo: '個人的な用事で実家へ',
    // ... その他のフィールド
  }
];
```

## テスト優先順位

### P1: 必須テスト（基本機能）
- TC-001, TC-002, TC-003: 基本CSV生成
- TC-025, TC-026: パフォーマンス（中量まで）
- TC-032, TC-033: ブラウザAPI基本
- TC-035, TC-039: エラー・特殊文字処理

### P2: 重要テスト（主要機能）
- TC-005, TC-009, TC-013: フィールド選択・フィルタ・プライバシー
- TC-017, TC-021: フォーマット機能
- TC-027, TC-043: 大量データ・統合テスト
- TC-046, TC-047: 主要ブラウザ対応

### P3: 補完テスト（高度機能）
- TC-029, TC-030: Web Worker
- TC-041, TC-044: 高度な統合テスト
- TC-048, TC-049: 追加ブラウザ対応

## テスト実行計画

### フェーズ1: 基本機能（1-2日）
- ユニットテスト実装
- 基本CSV生成機能の確認
- エラーハンドリングの基本実装

### フェーズ2: 主要機能（2-3日）
- フィールド選択・フィルタリング機能
- フォーマット機能の実装
- パフォーマンステスト

### フェーズ3: 高度機能（1-2日）
- Web Worker実装
- ブラウザ互換性確認
- 統合テスト完了