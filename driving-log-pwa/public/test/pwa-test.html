<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA機能テスト - 運転日報PWA</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2196F3;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ccc;
            display: inline-block;
        }
        .test-status.pass {
            background: #4CAF50;
        }
        .test-status.fail {
            background: #f44336;
        }
        .test-status.warning {
            background: #FF9800;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
        }
        .info-value {
            color: #333;
            font-size: 14px;
        }
        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        .install-prompt button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 6px;
            font-size: 16px;
        }
        .install-prompt button:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 PWA機能テスト</h1>
        
        <!-- PWA基本機能テスト -->
        <div class="test-section">
            <h2>
                <span class="test-status" id="basic-status"></span>
                PWA基本機能
            </h2>
            
            <div class="test-item">
                <span>Service Worker対応</span>
                <span id="sw-support">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>Service Worker登録状態</span>
                <span id="sw-registration">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>Manifestファイル</span>
                <span id="manifest-check">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>HTTPS/Localhost</span>
                <span id="https-check">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>インストール可能</span>
                <button id="test-install" onclick="testInstallability()">インストール可能性をテスト</button>
            </div>
        </div>

        <!-- アイコンテスト -->
        <div class="test-section">
            <h2>
                <span class="test-status" id="icons-status"></span>
                アイコン・ビジュアル
            </h2>
            
            <div class="test-item">
                <span>アプリアイコン (192x192)</span>
                <span id="icon-192">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>アプリアイコン (512x512)</span>
                <span id="icon-512">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>Apple Touch Icon</span>
                <span id="apple-icon">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>Favicon</span>
                <span id="favicon">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>テーマカラー</span>
                <span id="theme-color">チェック中...</span>
            </div>
        </div>

        <!-- ショートカットテスト -->
        <div class="test-section">
            <h2>
                <span class="test-status" id="shortcuts-status"></span>
                ショートカット機能
            </h2>
            
            <div class="test-item">
                <span>基本ショートカット</span>
                <span id="basic-shortcuts">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>ショートカットアイコン</span>
                <span id="shortcut-icons">チェック中...</span>
            </div>
            
            <div class="test-item">
                <span>動的ショートカット</span>
                <button onclick="testDynamicShortcuts()">動的ショートカットをテスト</button>
            </div>
        </div>

        <!-- オフライン機能テスト -->
        <div class="test-section">
            <h2>
                <span class="test-status" id="offline-status"></span>
                オフライン機能
            </h2>
            
            <div class="test-item">
                <span>キャッシュ機能</span>
                <button onclick="testCaching()">キャッシュをテスト</button>
            </div>
            
            <div class="test-item">
                <span>オフライン表示</span>
                <button onclick="testOfflineMode()">オフラインモードをテスト</button>
            </div>
            
            <div class="test-item">
                <span>同期機能</span>
                <button onclick="testSync()">同期機能をテスト</button>
            </div>
        </div>

        <!-- インストールプロンプト -->
        <div id="install-prompt" class="install-prompt" style="display: none;">
            <h3>📱 アプリをインストールしますか？</h3>
            <p>運転日報PWAをホーム画面に追加して、ネイティブアプリのように使用できます。</p>
            <button onclick="installApp()">インストール</button>
            <button onclick="dismissInstall()">後で</button>
        </div>

        <!-- 環境情報 -->
        <div class="test-section">
            <h2>環境情報</h2>
            <div class="info-grid" id="environment-info">
                <!-- 動的に生成 -->
            </div>
        </div>

        <!-- テストログ -->
        <div class="test-section">
            <h2>テストログ</h2>
            <div class="log" id="test-log"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">ログをクリア</button>
            <button onclick="downloadLog()">ログをダウンロード</button>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let testResults = {
            basic: [],
            icons: [],
            shortcuts: [],
            offline: []
        };

        // ログ機能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`PWA Test: ${message}`);
        }

        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }

        function downloadLog() {
            const logContent = document.getElementById('test-log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pwa-test-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // PWA基本機能テスト
        async function testBasicPWAFeatures() {
            log('PWA基本機能テストを開始します');

            // Service Worker対応チェック
            const swSupport = 'serviceWorker' in navigator;
            document.getElementById('sw-support').textContent = swSupport ? '✅ 対応' : '❌ 非対応';
            testResults.basic.push({ test: 'SW Support', result: swSupport });
            log(`Service Worker対応: ${swSupport ? '対応' : '非対応'}`, swSupport ? 'success' : 'error');

            // Service Worker登録状態チェック
            if (swSupport) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    const swRegistered = registration !== undefined;
                    document.getElementById('sw-registration').textContent = swRegistered ? '✅ 登録済み' : '⚠️ 未登録';
                    testResults.basic.push({ test: 'SW Registration', result: swRegistered });
                    log(`Service Worker登録: ${swRegistered ? '登録済み' : '未登録'}`, swRegistered ? 'success' : 'error');
                    
                    if (swRegistered) {
                        log(`Service Worker状態: ${registration.active ? 'active' : 'inactive'}`);
                        log(`Service Workerスコープ: ${registration.scope}`);
                    }
                } catch (error) {
                    document.getElementById('sw-registration').textContent = '❌ エラー';
                    log(`Service Worker登録チェックエラー: ${error.message}`, 'error');
                }
            }

            // Manifestファイルチェック
            try {
                const response = await fetch('/manifest.json');
                const manifestExists = response.ok;
                if (manifestExists) {
                    const manifest = await response.json();
                    document.getElementById('manifest-check').textContent = '✅ 正常';
                    testResults.basic.push({ test: 'Manifest', result: true });
                    log('Manifestファイル: 正常に読み込めました', 'success');
                    log(`アプリ名: ${manifest.name}`);
                    log(`ショートカット数: ${manifest.shortcuts?.length || 0}`);
                } else {
                    document.getElementById('manifest-check').textContent = '❌ エラー';
                    testResults.basic.push({ test: 'Manifest', result: false });
                    log('Manifestファイル: 読み込みエラー', 'error');
                }
            } catch (error) {
                document.getElementById('manifest-check').textContent = '❌ エラー';
                log(`Manifestファイルエラー: ${error.message}`, 'error');
            }

            // HTTPS/Localhostチェック
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            document.getElementById('https-check').textContent = isSecure ? '✅ セキュア' : '❌ 非セキュア';
            testResults.basic.push({ test: 'HTTPS', result: isSecure });
            log(`接続: ${isSecure ? 'セキュア (HTTPS/localhost)' : '非セキュア'}`, isSecure ? 'success' : 'error');

            updateSectionStatus('basic', testResults.basic.every(t => t.result));
        }

        // アイコンテスト
        async function testIcons() {
            log('アイコンテストを開始します');

            const iconTests = [
                { id: 'icon-192', path: '/icons/icon-192x192.svg', name: '192x192アイコン' },
                { id: 'icon-512', path: '/icons/icon-512x512.svg', name: '512x512アイコン' },
                { id: 'apple-icon', path: '/icons/apple-touch-icon.svg', name: 'Apple Touch Icon' },
                { id: 'favicon', path: '/icons/favicon.svg', name: 'Favicon' }
            ];

            for (const icon of iconTests) {
                try {
                    const response = await fetch(icon.path);
                    const exists = response.ok;
                    document.getElementById(icon.id).textContent = exists ? '✅ 存在' : '❌ 不存在';
                    testResults.icons.push({ test: icon.name, result: exists });
                    log(`${icon.name}: ${exists ? '存在' : '不存在'}`, exists ? 'success' : 'error');
                } catch (error) {
                    document.getElementById(icon.id).textContent = '❌ エラー';
                    log(`${icon.name}エラー: ${error.message}`, 'error');
                }
            }

            // テーマカラーチェック
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            const hasThemeColor = themeColorMeta !== null;
            document.getElementById('theme-color').textContent = hasThemeColor ? 
                `✅ ${themeColorMeta.content}` : '❌ 未設定';
            testResults.icons.push({ test: 'Theme Color', result: hasThemeColor });
            log(`テーマカラー: ${hasThemeColor ? themeColorMeta.content : '未設定'}`, hasThemeColor ? 'success' : 'error');

            updateSectionStatus('icons', testResults.icons.every(t => t.result));
        }

        // ショートカットテスト
        async function testShortcuts() {
            log('ショートカットテストを開始します');

            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    const shortcutsCount = manifest.shortcuts?.length || 0;
                    document.getElementById('basic-shortcuts').textContent = 
                        shortcutsCount > 0 ? `✅ ${shortcutsCount}個` : '❌ 未設定';
                    testResults.shortcuts.push({ test: 'Basic Shortcuts', result: shortcutsCount > 0 });
                    log(`基本ショートカット: ${shortcutsCount}個`, shortcutsCount > 0 ? 'success' : 'error');

                    // ショートカットアイコンチェック
                    if (shortcutsCount > 0) {
                        let iconCount = 0;
                        for (const shortcut of manifest.shortcuts) {
                            if (shortcut.icons && shortcut.icons.length > 0) {
                                iconCount++;
                            }
                        }
                        document.getElementById('shortcut-icons').textContent = 
                            iconCount === shortcutsCount ? '✅ 完備' : `⚠️ ${iconCount}/${shortcutsCount}`;
                        testResults.shortcuts.push({ test: 'Shortcut Icons', result: iconCount === shortcutsCount });
                        log(`ショートカットアイコン: ${iconCount}/${shortcutsCount}`, iconCount === shortcutsCount ? 'success' : 'error');
                    }
                }
            } catch (error) {
                log(`ショートカットテストエラー: ${error.message}`, 'error');
            }

            updateSectionStatus('shortcuts', testResults.shortcuts.every(t => t.result));
        }

        // インストール可能性テスト
        function testInstallability() {
            log('インストール可能性をテストします');
            
            if (deferredPrompt) {
                log('インストールプロンプトが利用可能です', 'success');
                document.getElementById('install-prompt').style.display = 'block';
                document.getElementById('test-install').textContent = '✅ インストール可能';
            } else {
                log('インストールプロンプトは利用できません', 'error');
                log('注意: Chromeでは30秒以上の操作後にプロンプトが表示されます', 'info');
                document.getElementById('test-install').textContent = '❌ インストール不可 (30秒待機後に再試行)';
                
                // 30秒後に自動再テスト
                setTimeout(() => {
                    if (deferredPrompt) {
                        log('30秒経過後: インストールプロンプトが利用可能になりました!', 'success');
                        document.getElementById('install-prompt').style.display = 'block';
                        document.getElementById('test-install').textContent = '✅ インストール可能';
                    } else {
                        log('30秒経過後も プロンプトは利用できません', 'error');
                    }
                }, 30000);
            }
        }

        // 動的ショートカットテスト
        async function testDynamicShortcuts() {
            log('動的ショートカットをテストします');
            
            try {
                const response = await fetch('/shortcuts/shortcuts-config.json');
                if (response.ok) {
                    const config = await response.json();
                    const dynamicCount = config.dynamic_shortcuts?.length || 0;
                    const contextualCount = config.contextual_shortcuts?.length || 0;
                    log(`動的ショートカット設定: ${dynamicCount}個`, dynamicCount > 0 ? 'success' : 'info');
                    log(`コンテキストショートカット設定: ${contextualCount}個`, contextualCount > 0 ? 'success' : 'info');
                } else {
                    log('ショートカット設定ファイルが見つかりません', 'error');
                }
            } catch (error) {
                log(`動的ショートカットテストエラー: ${error.message}`, 'error');
            }
        }

        // キャッシュテスト
        async function testCaching() {
            log('キャッシュ機能をテストします');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    log(`キャッシュストレージ: ${cacheNames.length}個のキャッシュが存在`, 'success');
                    
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        log(`${cacheName}: ${keys.length}個のアイテム`);
                    }
                    
                    testResults.offline.push({ test: 'Cache API', result: true });
                } catch (error) {
                    log(`キャッシュテストエラー: ${error.message}`, 'error');
                    testResults.offline.push({ test: 'Cache API', result: false });
                }
            } else {
                log('Cache APIが利用できません', 'error');
                testResults.offline.push({ test: 'Cache API', result: false });
            }
        }

        // オフラインモードテスト
        function testOfflineMode() {
            log('オフラインモードをテストします');
            
            const isOnline = navigator.onLine;
            log(`現在のネットワーク状態: ${isOnline ? 'オンライン' : 'オフライン'}`, 'info');
            
            // オフライン状態をシミュレート
            window.addEventListener('offline', () => {
                log('オフライン状態を検出しました', 'info');
            });
            
            window.addEventListener('online', () => {
                log('オンライン状態に復帰しました', 'success');
            });
            
            log('ネットワーク状態の監視を開始しました', 'success');
        }

        // 同期機能テスト
        function testSync() {
            log('同期機能をテストします');
            
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                log('Background Sync APIが利用可能です', 'success');
                testResults.offline.push({ test: 'Background Sync', result: true });
            } else {
                log('Background Sync APIが利用できません', 'error');
                testResults.offline.push({ test: 'Background Sync', result: false });
            }
            
            // Service Workerに同期メッセージを送信
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.active) {
                        registration.active.postMessage({
                            type: 'TEST_SYNC',
                            data: { timestamp: Date.now() }
                        });
                        log('Service Workerに同期テストメッセージを送信しました', 'success');
                    }
                });
            }

            updateSectionStatus('offline', testResults.offline.every(t => t.result));
        }

        // セクション状態更新
        function updateSectionStatus(section, passed) {
            const statusElement = document.getElementById(`${section}-status`);
            if (passed) {
                statusElement.className = 'test-status pass';
            } else {
                statusElement.className = 'test-status fail';
            }
        }

        // 環境情報表示
        function displayEnvironmentInfo() {
            const info = {
                'ユーザーエージェント': navigator.userAgent,
                'プラットフォーム': navigator.platform,
                'プロトコル': location.protocol,
                'ホスト': location.host,
                'Service Worker対応': 'serviceWorker' in navigator ? 'はい' : 'いいえ',
                'Cache API対応': 'caches' in window ? 'はい' : 'いいえ',
                'IndexedDB対応': 'indexedDB' in window ? 'はい' : 'いいえ',
                'Push API対応': 'PushManager' in window ? 'はい' : 'いいえ',
                'Notification API対応': 'Notification' in window ? 'はい' : 'いいえ',
                'Geolocation API対応': 'geolocation' in navigator ? 'はい' : 'いいえ'
            };

            const grid = document.getElementById('environment-info');
            grid.innerHTML = '';

            for (const [label, value] of Object.entries(info)) {
                const item = document.createElement('div');
                item.className = 'info-item';
                item.innerHTML = `
                    <div class="info-label">${label}</div>
                    <div class="info-value">${value}</div>
                `;
                grid.appendChild(item);
            }
        }

        // アプリインストール
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                log(`インストール結果: ${outcome}`, outcome === 'accepted' ? 'success' : 'info');
                deferredPrompt = null;
                document.getElementById('install-prompt').style.display = 'none';
            }
        }

        function dismissInstall() {
            document.getElementById('install-prompt').style.display = 'none';
        }

        // イベントリスナー設定
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log('インストールプロンプトが利用可能になりました', 'success');
        });

        window.addEventListener('appinstalled', () => {
            log('アプリがインストールされました!', 'success');
            deferredPrompt = null;
        });

        // Service Worker登録
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    log('Service Worker登録成功: ' + registration.scope, 'success');
                    return registration;
                } catch (error) {
                    log('Service Worker登録失敗: ' + error.message, 'error');
                    return null;
                }
            } else {
                log('Service Workerはサポートされていません', 'error');
                return null;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            log('PWAテストツールを初期化しています');
            
            // Service Worker登録
            await registerServiceWorker();
            
            displayEnvironmentInfo();
            
            await testBasicPWAFeatures();
            await testIcons();
            await testShortcuts();
            
            log('PWAテストが完了しました');
        });
    </script>
</body>
</html>